<script>
  document.addEventListener("htmx:afterSettle", function (evt) {
    const newTitle = evt.detail.xhr.getResponseHeader("HX-Title");
    if (newTitle) {
      document.title = newTitle;
    }
  });
</script>

<!-- Highlight.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js"></script>

<script>
  console.log('Script loading...');

  // Initialize highlight.js
  hljs.configure({ ignoreUnescapedHTML: true });
  console.log('Highlight.js configured');

  // Function to wrap code blocks in proper HTML
  function wrapCodeBlock(text, language) {
    return `<pre><code class="language-${language}">${text}</code></pre>`;
  }

  // Function to find and convert markdown code blocks
  function convertMarkdownCodeBlocks(element) {
    console.log('Converting markdown blocks in:', element);
    
    // Get the text content
    let content = element.innerHTML;
    console.log('Initial content:', content.slice(0, 100));

    // Find all code blocks with triple backticks
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    content = content.replace(codeBlockRegex, (match, language, code) => {
      console.log('Found code block, language:', language);
      return wrapCodeBlock(code, language || 'plaintext');
    });

    // Update the content if changes were made
    if (content !== element.innerHTML) {
      console.log('Updating content with wrapped code blocks');
      element.innerHTML = content;
    }
  }

  // Function to highlight code blocks
  function highlightCode() {
    console.log('highlightCode function called');
    
    // First convert markdown blocks
    document.querySelectorAll('.message').forEach(convertMarkdownCodeBlocks);
    
    // Then highlight all code blocks
    document.querySelectorAll('pre code').forEach((el, index) => {
      console.log(`Processing block ${index}`);
      if (!el.classList.contains('hljs')) {
        console.log(`Highlighting block ${index}`);
        try {
          hljs.highlightElement(el);
          console.log(`Block ${index} highlighted successfully`);
        } catch (error) {
          console.error(`Error highlighting block ${index}:`, error);
        }
      }
    });
  }

  // Watch for new content
  console.log('Setting up MutationObserver');
  const observer = new MutationObserver((mutations) => {
    console.log('Mutation observed:', mutations.length, 'changes');
    mutations.forEach((mutation) => {
      if (mutation.addedNodes.length) {
        // Small delay to ensure content is fully rendered
        setTimeout(() => {
          console.log('Processing new nodes');
          mutation.addedNodes.forEach(node => {
            if (node.nodeType === 1) { // Element node
              convertMarkdownCodeBlocks(node);
              node.querySelectorAll('pre code').forEach(el => {
                if (!el.classList.contains('hljs')) {
                  hljs.highlightElement(el);
                }
              });
            }
          });
        }, 100);
      }
    });
  });

  // Start observing chat messages
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded');
    const chatMessages = document.getElementById('chat-messages');
    console.log('Chat messages element:', chatMessages);
    
    if (chatMessages) {
      observer.observe(chatMessages, {
        childList: true,
        subtree: true,
        characterData: true
      });
      console.log('Observer started');
      highlightCode(); // Initial highlight
    } else {
      console.error('Could not find chat-messages element');
    }
  });

  // Also watch for WebSocket messages
  document.addEventListener('ws:message', () => {
    console.log('WebSocket message received');
    setTimeout(highlightCode, 100);
  });

  // Additional HTMX event listeners
  document.addEventListener('htmx:afterSwap', () => {
    console.log('HTMX swap occurred');
    setTimeout(highlightCode, 100);
  });

  document.addEventListener('htmx:afterRequest', () => {
    console.log('HTMX request completed');
    setTimeout(highlightCode, 100);
  });
</script>