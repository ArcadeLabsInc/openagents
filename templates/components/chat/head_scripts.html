<script>
  document.addEventListener("htmx:afterSettle", function (evt) {
    const newTitle = evt.detail.xhr.getResponseHeader("HX-Title");
    if (newTitle) {
      document.title = newTitle;
    }
  });
</script>

<!-- Highlight.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js"></script>

<script>
  // Initialize highlight.js
  hljs.configure({ ignoreUnescapedHTML: true });

  // Keep track of messages being processed
  const messageStates = new Map();

  // Function to wrap and highlight code blocks
  function processCodeBlocks(element) {
    const messageId = element.dataset.messageId;
    console.log('Processing message:', messageId);

    // Get the text content
    let content = element.innerHTML;

    // Find all code blocks with triple backticks
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let match;
    let lastIndex = 0;
    let newContent = '';

    while ((match = codeBlockRegex.exec(content)) !== null) {
      // Add text before the code block
      newContent += content.slice(lastIndex, match.index);
      
      // Add the wrapped and highlighted code block
      const language = match[1] || 'plaintext';
      const code = match[2];
      
      // Create temporary element to hold the code
      const tempElement = document.createElement('div');
      tempElement.innerHTML = `<pre><code class="language-${language}">${code}</code></pre>`;
      
      // Highlight the code
      const codeElement = tempElement.querySelector('code');
      hljs.highlightElement(codeElement);
      
      // Add the highlighted code
      newContent += tempElement.innerHTML;
      
      lastIndex = match.index + match[0].length;
    }

    // Add any remaining text
    newContent += content.slice(lastIndex);

    // Only update if content changed
    if (newContent !== content) {
      element.innerHTML = newContent;
    }
  }

  // Process messages when streaming is complete
  document.addEventListener('ws:message', (event) => {
    try {
      const data = JSON.parse(event.detail.message);
      console.log('Message received:', data);

      if (data.status === 'complete') {
        console.log('Message complete, processing code blocks');
        // Wait a bit for the final content to render
        setTimeout(() => {
          const messages = document.querySelectorAll('.message');
          messages.forEach(processCodeBlocks);
        }, 100);
      }
    } catch (error) {
      console.error('Error processing message:', error);
    }
  });

  // Initial processing for any existing messages
  document.addEventListener('DOMContentLoaded', () => {
    const messages = document.querySelectorAll('.message');
    messages.forEach(processCodeBlocks);
  });
</script>